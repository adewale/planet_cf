<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - {{ planet.name }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="admin-header">
        <h1>Admin Dashboard</h1>
        <div class="admin-user">
            {% if admin.avatar_url %}
            <img src="{{ admin.avatar_url }}" alt="{{ admin.github_username }}" class="avatar">
            {% endif %}
            <span>Welcome, {{ admin.display_name or admin.github_username }}</span>
            <form action="/admin/logout" method="POST" style="display: inline;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </header>

    <nav class="admin-nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/feeds">Feeds</a>
        <a href="/admin/audit">Audit Log</a>
        <a href="/" target="_blank">View Site</a>
    </nav>

    <main class="admin-main">
        <section class="admin-section">
            <h2>Add New Feed</h2>
            <form action="/admin/feeds" method="POST" class="add-feed-form">
                <div class="form-group">
                    <label for="url">Feed URL</label>
                    <input type="url" id="url" name="url" placeholder="https://example.com/feed.xml" required>
                </div>
                <div class="form-group">
                    <label for="title">Title (optional)</label>
                    <input type="text" id="title" name="title" placeholder="Feed title">
                </div>
                <button type="submit">Add Feed</button>
            </form>
        </section>

        <section class="admin-section">
            <h2>Manage Feeds</h2>
            <table class="feeds-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>URL</th>
                        <th>Status</th>
                        <th>Last Success</th>
                        <th>Failures</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feed in feeds %}
                    <tr class="{{ 'unhealthy' if feed.consecutive_failures >= 3 else '' }}">
                        <td>{{ feed.title or 'Untitled' }}</td>
                        <td class="url-cell">
                            <a href="{{ feed.url }}" target="_blank" title="{{ feed.url }}">
                                {{ feed.url[:40] }}{% if feed.url|length > 40 %}...{% endif %}
                            </a>
                        </td>
                        <td>
                            <span class="status-badge {{ 'active' if feed.is_active else 'paused' }}">
                                {{ 'Active' if feed.is_active else 'Paused' }}
                            </span>
                        </td>
                        <td>{{ feed.last_success_at or 'Never' }}</td>
                        <td>{{ feed.consecutive_failures or 0 }}</td>
                        <td class="actions-cell">
                            <form action="/admin/feeds/{{ feed.id }}" method="POST" style="display: inline;">
                                <input type="hidden" name="_method" value="DELETE">
                                <button type="submit" class="delete-btn" onclick="return confirm('Delete this feed?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="empty-state">No feeds yet. Add one above!</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="admin-section">
            <h2>Import OPML</h2>
            <p>Upload an OPML file to bulk import feeds.</p>
            <form action="/admin/import-opml" method="POST" enctype="multipart/form-data" class="import-form">
                <input type="file" name="opml" accept=".opml,.xml" required>
                <button type="submit">Import Feeds</button>
            </form>
        </section>

        <section class="admin-section">
            <h2>Manual Actions</h2>
            <div class="action-buttons">
                <form action="/admin/regenerate" method="POST" style="display: inline;">
                    <button type="submit">Force Feed Refresh</button>
                </form>
                <a href="/feeds.opml" class="btn" download>Export OPML</a>
            </div>
        </section>

        <section class="admin-section">
            <h2>System Stats</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value">{{ feeds|length }}</span>
                    <span class="stat-label">Total Feeds</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ feeds|selectattr('is_active')|list|length }}</span>
                    <span class="stat-label">Active Feeds</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ feeds|selectattr('consecutive_failures', 'ge', 3)|list|length }}</span>
                    <span class="stat-label">Failing Feeds</span>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>Planet CF Admin - <a href="/">Back to Site</a></p>
    </footer>
</body>
</html>
